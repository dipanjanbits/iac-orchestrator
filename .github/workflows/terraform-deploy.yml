name: 'Terraform Multi-Cloud Deployment'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      clouds:
        description: 'Cloud provider(s) to deploy to (comma-separated: aws,azure,gcp or leave empty for all enabled)'
        required: false
        type: string
        default: ''
      modules:
        description: 'Module(s) to deploy (comma-separated: network,compute or leave empty for all)'
        required: false
        type: string
        default: ''
      skip_validation:
        description: 'Skip terraform validation step'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run mode (plan only, no apply/destroy)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  terraform-deploy:
    name: 'Terraform Deploy'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Configure AWS Credentials (Method 1: Access Keys)
        continue-on-error: true
        if: secrets.AWS_ACCESS_KEY_ID != ''
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ secrets.AWS_REGION || 'us-east-1' }}" >> $GITHUB_ENV
          echo "âœ“ AWS credentials configured using Access Key ID & Secret Key"

      - name: Configure AWS Credentials (Method 2: IAM Role - OIDC)
        continue-on-error: true
        if: secrets.AWS_ACCESS_KEY_ID == '' && secrets.AWS_ROLE_TO_ASSUME != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Configure Azure Credentials
        continue-on-error: true
        run: |
          if [[ ! -z "${{ secrets.AZURE_CLIENT_ID }}" ]]; then
            echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
            echo "ARM_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
            echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
            echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
            echo "âœ“ Azure credentials configured"
          else
            echo "âš ï¸  Azure credentials not configured (optional)"
          fi

      - name: Configure GCP Credentials
        continue-on-error: true
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup GCP Cloud SDK
        continue-on-error: true
        uses: google-github-actions/setup-gcloud@v1

      - name: Parse Inputs
        id: parse
        shell: bash
        run: |
          set -e
          
          # Parse clouds input
          if [[ -z "${{ github.event.inputs.clouds }}" ]]; then
            CLOUDS=""
            echo "clouds=" >> $GITHUB_OUTPUT
          else
            CLOUDS=$(echo "${{ github.event.inputs.clouds }}" | tr ',' ' ')
            echo "clouds=$CLOUDS" >> $GITHUB_OUTPUT
          fi
          
          # Parse modules input
          if [[ -z "${{ github.event.inputs.modules }}" ]]; then
            MODULES=""
            echo "modules=" >> $GITHUB_OUTPUT
          else
            MODULES=$(echo "${{ github.event.inputs.modules }}" | tr ',' ' ')
            echo "modules=$MODULES" >> $GITHUB_OUTPUT
          fi
          
          # Determine action (respect dry_run flag)
          ACTION="${{ github.event.inputs.action }}"
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]] && [[ "$ACTION" != "plan" ]]; then
            echo "action=plan" >> $GITHUB_OUTPUT
            echo "DRY_RUN=true" >> $GITHUB_OUTPUT
            echo "dry_run_notice=âš ï¸ DRY RUN MODE: Running 'plan' instead of '$ACTION'" >> $GITHUB_OUTPUT
          else
            echo "action=$ACTION" >> $GITHUB_OUTPUT
            echo "DRY_RUN=false" >> $GITHUB_OUTPUT
          fi

      - name: Display Configuration
        shell: bash
        run: |
          echo "=========================================="
          echo "Terraform Deployment Configuration"
          echo "=========================================="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Action: ${{ steps.parse.outputs.action }}"
          echo "Clouds: ${{ steps.parse.outputs.clouds || 'All enabled clouds' }}"
          echo "Modules: ${{ steps.parse.outputs.modules || 'All modules' }}"
          echo "Skip Validation: ${{ github.event.inputs.skip_validation }}"
          echo "Dry Run Mode: ${{ github.event.inputs.dry_run }}"
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "${{ steps.parse.outputs.dry_run_notice }}"
          fi
          echo "Triggered by: ${{ github.actor }}"
          echo "=========================================="

      - name: Build Orchestrator Command
        id: build-cmd
        shell: bash
        run: |
          set -e
          CMD="python orchestrator.py -e ${{ github.event.inputs.environment }} -a ${{ steps.parse.outputs.action }}"
          
          if [[ ! -z "${{ steps.parse.outputs.clouds }}" ]]; then
            CMD="$CMD -c ${{ steps.parse.outputs.clouds }}"
          fi
          
          if [[ ! -z "${{ steps.parse.outputs.modules }}" ]]; then
            CMD="$CMD -m ${{ steps.parse.outputs.modules }}"
          fi
          
          echo "cmd=$CMD" >> $GITHUB_OUTPUT
          echo "Full command: $CMD"

      - name: Validate Parameters
        run: |
          python3 << 'EOF'
          import json
          
          with open('parameters.json', 'r') as f:
            params = json.load(f)
          
          env = '${{ github.event.inputs.environment }}'
          
          if env not in params['environments']:
            print(f"âŒ ERROR: Environment '{env}' not found in parameters.json")
            print(f"Available environments: {', '.join(params['environments'].keys())}")
            exit(1)
          
          print(f"âœ“ Environment '{env}' found")
          
          # Validate clouds if specified
          if '${{ steps.parse.outputs.clouds }}':
            clouds_input = '${{ steps.parse.outputs.clouds }}'.split()
            for cloud in clouds_input:
              if cloud not in params['environments'][env]:
                print(f"âŒ ERROR: Cloud '{cloud}' not configured for environment '{env}'")
                exit(1)
              print(f"âœ“ Cloud '{cloud}' configured")
          
          # Validate modules if specified
          if '${{ steps.parse.outputs.modules }}':
            modules_input = '${{ steps.parse.outputs.modules }}'.split()
            env_config = params['environments'][env]
            
            for cloud in ['aws', 'azure', 'gcp']:
              if cloud in env_config:
                cloud_modules = env_config[cloud].get('modules', {})
                for module in modules_input:
                  if module not in cloud_modules:
                    print(f"âš ï¸  WARNING: Module '{module}' not found in {cloud}")
            
            print(f"âœ“ Modules specified: {', '.join(modules_input)}")
          
          print("\nâœ“ All validations passed!")
          EOF

      - name: Run Terraform Orchestrator
        run: ${{ steps.build-cmd.outputs.cmd }}

      - name: Generate Plan Summary
        if: success() && steps.parse.outputs.action == 'plan'
        run: |
          echo "## ðŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ steps.parse.outputs.action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clouds | ${{ steps.parse.outputs.clouds || 'All enabled' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Modules | ${{ steps.parse.outputs.modules || 'All modules' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Post Deployment Status
        if: success()
        run: |
          echo "## âœ… Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ steps.parse.outputs.action }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Failed" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ steps.parse.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Check logs for details**" >> $GITHUB_STEP_SUMMARY
